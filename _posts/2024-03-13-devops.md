---
title: "DevOps å·¥å…·é“¾ä¸æœ€ä½³å®è·µå®Œå…¨æŒ‡å—"
author: Kk
date: 2024-03-13
category: DevOps
layout: post
tags: [devops, ci-cd, automation, docker, kubernetes, monitoring]
excerpt: "æ·±å…¥æ¢è®¨DevOpsæ–‡åŒ–ã€å·¥å…·é“¾é€‰æ‹©å’Œæœ€ä½³å®è·µï¼Œä»ä»£ç æäº¤åˆ°ç”Ÿäº§éƒ¨ç½²çš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ã€‚"
diagram: |
  graph TB
      subgraph "DevOpså·¥å…·é“¾æ¶æ„"
          subgraph "å¼€å‘é˜¶æ®µ Development"
              DEV[å¼€å‘äººå‘˜]
              IDE[é›†æˆå¼€å‘ç¯å¢ƒ<br/>VS Code/IntelliJ]
              GIT[ç‰ˆæœ¬æ§åˆ¶<br/>Git/GitHub/GitLab]
              CODE_REVIEW[ä»£ç å®¡æŸ¥<br/>Pull Request]
          end

          subgraph "æŒç»­é›†æˆ CI"
              CI_SERVER[CIæœåŠ¡å™¨<br/>Jenkins/GitLab CI]
              BUILD[æ„å»ºå·¥å…·<br/>Maven/Gradle/npm]
              UNIT_TEST[å•å…ƒæµ‹è¯•<br/>JUnit/Jest/pytest]
              CODE_QUALITY[ä»£ç è´¨é‡<br/>SonarQube]
              SECURITY_SCAN[å®‰å…¨æ‰«æ<br/>SAST/DAST]
              ARTIFACT[åˆ¶å“ä»“åº“<br/>Nexus/Artifactory]
          end

          subgraph "å®¹å™¨åŒ– Containerization"
              DOCKER[Dockerå®¹å™¨]
              DOCKER_REGISTRY[é•œåƒä»“åº“<br/>Docker Hub/Harbor]
              DOCKERFILE[Dockerfile]
              DOCKER_COMPOSE[Docker Compose]
          end

          subgraph "æŒç»­éƒ¨ç½² CD"
              CD_PIPELINE[CDæµæ°´çº¿]
              STAGING[é¢„å‘å¸ƒç¯å¢ƒ]
              PROD_DEPLOY[ç”Ÿäº§éƒ¨ç½²]
              ROLLBACK[å›æ»šæœºåˆ¶]
              BLUE_GREEN[è“ç»¿éƒ¨ç½²]
              CANARY[é‡‘ä¸é›€å‘å¸ƒ]
          end

          subgraph "åŸºç¡€è®¾æ–½å³ä»£ç  IaC"
              TERRAFORM[Terraform]
              ANSIBLE[Ansible]
              CLOUDFORMATION[CloudFormation]
              HELM[Helm Charts]
              KUSTOMIZE[Kustomize]
          end

          subgraph "å®¹å™¨ç¼–æ’ Orchestration"
              KUBERNETES[Kubernetesé›†ç¾¤]
              PODS[Podå®¹å™¨ç»„]
              SERVICES[æœåŠ¡å‘ç°]
              INGRESS[å…¥å£æ§åˆ¶å™¨]
              CONFIG_MAP[é…ç½®ç®¡ç†]
              SECRETS[å¯†é’¥ç®¡ç†]
          end

          subgraph "ç›‘æ§å’Œå¯è§‚æµ‹æ€§ Observability"
              PROMETHEUS[Prometheusç›‘æ§]
              GRAFANA[Grafanaä»ªè¡¨æ¿]
              ELK[ELKæ—¥å¿—æ ˆ]
              JAEGER[é“¾è·¯è¿½è¸ª<br/>Jaeger/Zipkin]
              ALERT_MANAGER[å‘Šè­¦ç®¡ç†]
              APM[åº”ç”¨æ€§èƒ½ç›‘æ§]
          end

          subgraph "å®‰å…¨å’Œåˆè§„ Security"
              VAULT[å¯†é’¥ç®¡ç†<br/>HashiCorp Vault]
              RBAC[è§’è‰²è®¿é—®æ§åˆ¶]
              POLICY[å®‰å…¨ç­–ç•¥<br/>OPA/Falco]
              COMPLIANCE[åˆè§„æ£€æŸ¥]
              VULNERABILITY[æ¼æ´æ‰«æ]
          end

          subgraph "åä½œå’Œæ²Ÿé€š Collaboration"
              SLACK[Slack/Teams]
              JIRA[é¡¹ç›®ç®¡ç†<br/>Jira/Trello]
              CONFLUENCE[æ–‡æ¡£åä½œ]
              INCIDENT[äº‹ä»¶ç®¡ç†<br/>PagerDuty]
          end
      end

      DEV --> IDE
      IDE --> GIT
      GIT --> CODE_REVIEW
      CODE_REVIEW --> CI_SERVER

      CI_SERVER --> BUILD
      CI_SERVER --> UNIT_TEST
      CI_SERVER --> CODE_QUALITY
      CI_SERVER --> SECURITY_SCAN
      BUILD --> ARTIFACT

      ARTIFACT --> DOCKER
      DOCKER --> DOCKERFILE
      DOCKER --> DOCKER_COMPOSE
      DOCKER --> DOCKER_REGISTRY

      DOCKER_REGISTRY --> CD_PIPELINE
      CD_PIPELINE --> STAGING
      STAGING --> PROD_DEPLOY
      PROD_DEPLOY --> ROLLBACK
      CD_PIPELINE --> BLUE_GREEN
      CD_PIPELINE --> CANARY

      TERRAFORM --> KUBERNETES
      ANSIBLE --> KUBERNETES
      HELM --> KUBERNETES
      KUBERNETES --> PODS
      KUBERNETES --> SERVICES
      KUBERNETES --> INGRESS
      KUBERNETES --> CONFIG_MAP
      KUBERNETES --> SECRETS

      PODS --> PROMETHEUS
      SERVICES --> PROMETHEUS
      PROMETHEUS --> GRAFANA
      PODS --> ELK
      SERVICES --> JAEGER
      PROMETHEUS --> ALERT_MANAGER
      GRAFANA --> APM

      VAULT --> SECRETS
      RBAC --> KUBERNETES
      POLICY --> KUBERNETES
      VULNERABILITY --> SECURITY_SCAN

      ALERT_MANAGER --> SLACK
      CI_SERVER --> JIRA
      DEV --> CONFLUENCE
      ALERT_MANAGER --> INCIDENT

      style CI_SERVER fill:#ff6b6b,stroke:#fff,stroke-width:2px,color:#fff
      style KUBERNETES fill:#326ce5,stroke:#fff,stroke-width:2px,color:#fff
      style DOCKER fill:#0db7ed,stroke:#fff,stroke-width:2px,color:#fff
      style PROMETHEUS fill:#e6522c,stroke:#fff,stroke-width:2px,color:#fff
      style GRAFANA fill:#f46800,stroke:#fff,stroke-width:2px,color:#fff
      style TERRAFORM fill:#623ce4,stroke:#fff,stroke-width:2px,color:#fff
      style ANSIBLE fill:#ee0000,stroke:#fff,stroke-width:2px,color:#fff
      style VAULT fill:#000000,stroke:#fff,stroke-width:2px,color:#fff
      style GIT fill:#f05032,stroke:#fff,stroke-width:2px,color:#fff
      style SLACK fill:#4a154b,stroke:#fff,stroke-width:2px,color:#fff
---

# DevOps å®ç”¨å·¥å…·ä¸æœ€ä½³å®è·µ ğŸš€

> DevOpsæ˜¯å¼€å‘å’Œè¿ç»´çš„å®Œç¾ç»“åˆï¼Œé€šè¿‡è‡ªåŠ¨åŒ–ã€ç›‘æ§å’Œåä½œæ¥åŠ é€Ÿè½¯ä»¶äº¤ä»˜ã€‚

## ğŸ“Š ç›®å½•

- [Git ç‰ˆæœ¬æ§åˆ¶](#git-ç‰ˆæœ¬æ§åˆ¶)
- [Docker å®¹å™¨åŒ–](#docker-å®¹å™¨åŒ–)
- [CI/CD è‡ªåŠ¨åŒ–](#cicd-è‡ªåŠ¨åŒ–)
- [ç›‘æ§ä¸æ—¥å¿—](#ç›‘æ§ä¸æ—¥å¿—)
- [åŸºç¡€è®¾æ–½å³ä»£ç ](#åŸºç¡€è®¾æ–½å³ä»£ç )
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ”§ Git ç‰ˆæœ¬æ§åˆ¶

### åŸºæœ¬æ“ä½œ
```bash
# è®¾ç½®æ–‡ä»¶ä¸ºå¯æ‰§è¡Œ
git update-index --chmod=+x <file>

# æŸ¥çœ‹æ–‡ä»¶æƒé™å˜æ›´
git ls-files --stage <file>

# å¼ºåˆ¶æ¨é€ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
git push --force-with-lease origin main
```

### é«˜çº§GitæŠ€å·§
```bash
# äº¤äº’å¼å˜åŸºï¼Œæ•´ç†æäº¤å†å²
git rebase -i HEAD~3

# æš‚å­˜éƒ¨åˆ†æ–‡ä»¶å†…å®¹
git add -p <file>

# æŸ¥æ‰¾å¼•å…¥bugçš„æäº¤
git bisect start
git bisect bad HEAD
git bisect good v1.0

# æŸ¥çœ‹æ–‡ä»¶æ¯è¡Œçš„æœ€åä¿®æ”¹
git blame <file>

# æ¢å¤åˆ é™¤çš„åˆ†æ”¯
git reflog
git checkout -b <branch-name> <commit-hash>
```

### Gitå·¥ä½œæµ
```bash
# Gitflowå·¥ä½œæµç¤ºä¾‹
git flow init
git flow feature start new-feature
git flow feature finish new-feature

# åˆ›å»ºå‘å¸ƒåˆ†æ”¯
git flow release start 1.0.0
git flow release finish 1.0.0
```

---

## ğŸ³ Docker å®¹å™¨åŒ–

### Dockerfile æœ€ä½³å®è·µ
```dockerfile
# å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:16-alpine AS runtime
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001
WORKDIR /app
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --chown=nodejs:nodejs . .
USER nodejs
EXPOSE 3000
CMD ["node", "server.js"]
```

### Docker Compose æœåŠ¡ç¼–æ’
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - db
    restart: unless-stopped

  db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
```

### å¸¸ç”¨Dockerå‘½ä»¤
```bash
# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune -af

# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it <container_id> /bin/bash

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
docker stats

# å¯¼å‡º/å¯¼å…¥é•œåƒ
docker save -o app.tar myapp:latest
docker load -i app.tar

# å¤šå¹³å°æ„å»º
docker buildx create --use
docker buildx build --platform linux/amd64,linux/arm64 -t myapp:latest --push .
```

---

## âš™ï¸ CI/CD è‡ªåŠ¨åŒ–

### GitHub Actionså·¥ä½œæµ
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Run security audit
      run: npm audit

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to production
      run: |
        echo "Deploying to production..."
        # éƒ¨ç½²è„šæœ¬
```

### Jenkins Pipeline ç¤ºä¾‹
```groovy
pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'registry.example.com'
        IMAGE_NAME = 'myapp'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Test') {
            steps {
                sh 'npm test'
                publishTestResults testResultsPattern: 'test-results.xml'
            }
        }

        stage('Build') {
            steps {
                script {
                    def image = docker.build("${IMAGE_NAME}:${BUILD_NUMBER}")
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                sh """
                    kubectl set image deployment/myapp \
                    myapp=${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER}
                """
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
```

---

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### Prometheus é…ç½®
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']

  - job_name: 'application'
    static_configs:
      - targets: ['app:3000']
    metrics_path: '/metrics'
```

### æ—¥å¿—èšåˆé…ç½®
```yaml
# docker-compose.yml for ELK stack
version: '3.8'
services:
  elasticsearch:
    image: elasticsearch:7.14.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"

  logstash:
    image: logstash:7.14.0
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    ports:
      - "5044:5044"

  kibana:
    image: kibana:7.14.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
```

---

## ğŸ—ï¸ åŸºç¡€è®¾æ–½å³ä»£ç 

### Terraform ç¤ºä¾‹
```hcl
# AWS EC2 å®ä¾‹é…ç½®
provider "aws" {
  region = var.aws_region
}

resource "aws_security_group" "web" {
  name_prefix = "web-sg"

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_instance" "web" {
  ami                    = var.ami_id
  instance_type          = var.instance_type
  vpc_security_group_ids = [aws_security_group.web.id]

  user_data = file("${path.module}/user-data.sh")

  tags = {
    Name        = "web-server"
    Environment = var.environment
  }
}
```

### Ansible Playbook
```yaml
---
- name: Configure web servers
  hosts: webservers
  become: yes

  vars:
    nginx_port: 80
    app_user: webapp

  tasks:
    - name: Install Nginx
      package:
        name: nginx
        state: present

    - name: Start and enable Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes

    - name: Deploy application
      copy:
        src: "{{ item }}"
        dest: /var/www/html/
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
      with_fileglob:
        - "dist/*"
      notify: restart nginx

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
```

---

## ğŸ“‹ æœ€ä½³å®è·µ

### ğŸ”’ å®‰å…¨å®è·µ
```bash
# æ‰«æDockeré•œåƒæ¼æ´
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image myapp:latest

# å¯†é’¥ç®¡ç†
kubectl create secret generic mysecret \
  --from-literal=username=admin \
  --from-literal=password='S3cur3P@ssw0rd'

# ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
```bash
# èµ„æºé™åˆ¶
resources:
  requests:
    memory: "64Mi"
    cpu: "250m"
  limits:
    memory: "128Mi"
    cpu: "500m"

# å¥åº·æ£€æŸ¥
livenessProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /ready
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 5
```

### ğŸ“Š æŒ‡æ ‡æ”¶é›†
```javascript
// Node.js PrometheusæŒ‡æ ‡ç¤ºä¾‹
const prometheus = require('prom-client');

const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'status_code'],
  buckets: [0.1, 0.5, 1, 2, 5]
});

const httpRequestsTotal = new prometheus.Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'status_code']
});

// ä¸­é—´ä»¶ä½¿ç”¨
app.use((req, res, next) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    httpRequestDuration
      .labels(req.method, res.statusCode)
      .observe(duration);
    httpRequestsTotal
      .labels(req.method, res.statusCode)
      .inc();
  });

  next();
});
```

---

## ğŸ› ï¸ æœ‰ç”¨çš„è„šæœ¬

### å¥åº·æ£€æŸ¥è„šæœ¬
```bash
#!/bin/bash
# health-check.sh

SERVICE_URL="http://localhost:3000/health"
MAX_RETRIES=3
RETRY_INTERVAL=5

for i in $(seq 1 $MAX_RETRIES); do
    if curl -f -s "$SERVICE_URL" > /dev/null; then
        echo "Service is healthy"
        exit 0
    else
        echo "Health check failed (attempt $i/$MAX_RETRIES)"
        if [ $i -lt $MAX_RETRIES ]; then
            sleep $RETRY_INTERVAL
        fi
    fi
done

echo "Service is unhealthy after $MAX_RETRIES attempts"
exit 1
```

### å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="myapp"

# æ•°æ®åº“å¤‡ä»½
docker exec postgres pg_dump -U postgres $DB_NAME > "$BACKUP_DIR/db_$DATE.sql"

# å‹ç¼©å¤‡ä»½
gzip "$BACKUP_DIR/db_$DATE.sql"

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete

echo "Backup completed: db_$DATE.sql.gz"
```

---

## ğŸ“š æ¨èå·¥å…·

| ç±»åˆ« | å·¥å…· | ç”¨é€” |
|------|------|------|
| **å®¹å™¨** | Docker, Podman | å®¹å™¨åŒ–åº”ç”¨ |
| **ç¼–æ’** | Kubernetes, Docker Swarm | å®¹å™¨ç¼–æ’ |
| **CI/CD** | Jenkins, GitLab CI, GitHub Actions | æŒç»­é›†æˆ/éƒ¨ç½² |
| **ç›‘æ§** | Prometheus, Grafana, ELK | ç›‘æ§å’Œæ—¥å¿— |
| **IaC** | Terraform, Ansible, Pulumi | åŸºç¡€è®¾æ–½å³ä»£ç  |
| **å®‰å…¨** | Vault, Trivy, Falco | å®‰å…¨æ‰«æå’Œç®¡ç† |

---

ğŸ’¡ **å°è´´å£«**: DevOpsæ˜¯ä¸€ä¸ªæŒç»­å­¦ä¹ çš„è¿‡ç¨‹ï¼Œå…³é”®æ˜¯è‡ªåŠ¨åŒ–ä¸€åˆ‡å¯ä»¥è‡ªåŠ¨åŒ–çš„æµç¨‹ï¼Œæé«˜å¼€å‘å’Œè¿ç»´æ•ˆç‡ã€‚
